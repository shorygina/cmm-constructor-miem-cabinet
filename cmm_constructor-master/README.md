# База КИМов

База КИМов - сервис для преподавателей МИЭМ НИУ ВШЭ. С помощью него можно удобно хранить все тестовые вопросы, при необходимости редактировать их и, главное, быстро раздавать персональные задания в Google Classroom. Преподаватель может указать дату и время начала и окончания задания, и по их истечению оценки автоматически проставятся в грейдбук Classroom.

### Оглавление
* [Описание работы программы](#описание-работы-программы)
* [Настройки](#настройки)
  * [Создание папки](#создание-папки)
  * [Настройка проекта в Google Cloud Platform](#настройка-проекта-в-google-cloud-platform)
  * [Получение токенов](#получение-токенов)
  * [Настройка проекта в Google Apps Script](#настройка-проекта-в-google-apps-script)
  * [Создание шаблонов google-формы и google-таблицы](#создание-шаблонов-google-формы-и-google-таблицы)
* [Запросы](#запросы)


## Описание работы программы
Для работы программы подразумевается, что существует административный аккаунт, который является преподавателем во всех курсах (в данном случае class@miem.hse.ru). Он нужен для того, чтобы настроить работу с Google Cloud Platform и Google Apps Script,
а также от его лица будут выполняться действия во всех связанных сервисах.

При первом входе пользователя в сервис на Google-диске административного аккаунта в директории *Мой диск/Classroom/База КИМов* создается персональная папка пользователя, где будут храниться все созданные им файлы (например, для aavilgelm@miem.hse.ru будет создана папка "aavilgelm"). Одновременно с этим в базу данных в таблицу `user` заносится информация о новом пользователе - email и id личной папки. 

После входа у пользователя открывается его личная страница, на которой отображаются преподаваемые им курсы (данные берутся из Сlassroom, заносятся в базу данных в таблицу `course`) и существующие КИМы (т.е. google-таблицы, которые проверяются в личной директории и также заносятся в базу данных в таблицу `spreadsheet`). Пользователь может создать новый КИМ, открыть КИМ, сформировать из КИМа задания, просмотреть сформированные задания, раздать задания в Classroom, удалить задания, удалить КИМ.

При создании нового КИМа в личной папке пользователя создается google-таблица с заданным названием и личная папка, в которую будут создаваться google-формы, генерируемые из этого КИМа. При просмотре сгенерированных заданий у пользователя открывается именно эта папка. Для раздачи заданий в Classroom создаются персональные задания для каждого студента, к ним прикрепляются разные варианты заданий. Но также создается еще одно задание, назначенное для всех, в которое по завершению времени выставляются все оценки. При удалении КИМа удаляется google-таблица и связанная с ней папка.


## Настройки

### Создание папки
1. В административном аккаунте в директории *Мой диск/Classroom* создайте папку **"База КИМов"**.

2. Запустите функцию `get_base_folder_id()` из файла `functions.py` и найдите идентификатор созданной папки.

3. В этом же файле внесите идентификатор в переменную `CLASS_BASE_FOLDER_ID`.


### Настройка проекта в Google Cloud Platform
1. Перейдите по [ссылке](https://console.cloud.google.com/home/) в Google Cloud Platform, создайте новый проект и перейдите в него.

2. Выберите вкладку "API и сервисы" и перейдите в раздел "Библиотека". В нем подключите следующие API: Google Classroom API, Google Drive API, Google Sheets API, Apps Script API, Admin SDK. 

3. Находясь в "API и сервисы" выберите раздел "Окно запроса доступа OAuth" и настройте его со следующими параметрами: тип приложения - ограниченный доступ, название и логотип выберите сами, укажите ссылку на главную страницу приложения. 

4. Затем перейдите в раздел "Учетные данные" и создайте идентификатор клиента OAuth 2.0, тип приложение укажите как "другие типы". 

5. Скачайте файл json с данными и добавьте в проект как `credentials.json`.   


### Получение токенов
Для работы программы нужен токен административного аккаунта. Заранее запустите функцию `get_credentials_for_class()`, которая создаст файл `classtoken.pickle` с токеном административного аккаунта.


### Настройка проекта в Google Apps Script
Подробный, а главное работающий метод настройки написан [здесь](https://habr.com/ru/post/485898/).

Главное, что нужно запомнить - если вы измените код в скрипте Apps Script - удаленно вы запустить его не сможете. Всегда сначала меняйте его в файле, потом запускайте функцию `update_script()` и уже после этого запускайте его удаленно.


### Создание шаблонов google-формы и google-таблицы
Шаблон google-формы нужен для того, чтобы копировать его и создавать на его основе новые формы. Делается это для того, что программно невозможно задать все настройки google-форм, нужные для работы приложения.

Шаблон google-таблицы используется также для того, чтобы копировать его и использовать как шаблон для создания КИМов. В шаблонной таблице уже заданы названия полей, которые пользователю потребуется заполнить.

1. В директорию административного аккаунта *Мой диск/Classroom/База КИМов* скопируйте шаблоны google-формы и google-таблицы и назовите их "Шаблон формы" и "Шаблон таблицы" соответственно. 

2. С помощью функции `get_form_pattern_id()` в `functions.py` найдите идентификатор формы и внесите его в переменную `FORM_PATTERN_ID`. 

3. С помощью функции `get_spreadsheet_pattern_id()` в `functions.py` найдите идентификатор таблицы и внесите его в переменную `SPREADSHEET_PATTERN_ID`. 


## Запросы

route | назначение | формат входных данных | формат выходных данных
--- | --- | --- | ---
/main | данные о КИМах и курсах пользователя | {"user_email": email пользователя} | {"courses": [{"courseId": id курса, "courseName": имя курса, "courseUrl": ссылка на курс}], "cmms": [{"spreadsheetId": id таблицы (КИМа), "spreadsheetName": имя таблицы, "spreadsheetUrl": ссылка на таблицу}]}
/get_information/<spreadsheet_id>&<spreadsheet_name> | данные о таблице (КИМе) | id и имя таблицы | {"spreadsheetId": id таблицы, "spreadsheetName": имя таблицы, "spreadsheetInfo": [{"title": название листа таблицы, "questionsAmount": количество вопросов в листе}]}
/open_folder | получить ссылку на папку со сгенерированными google-формами из определенного КИМа | {"spreadsheetId": id таблицы (КИМа)} | {"url": ссылка}
/delete_cmm | удалить таблицу (КИМ) | {"spreadsheetId": id таблицы} | -
/create_variants/<questions>&<amount>&<spreadsheet_id> | сгенерировать формы (варианты заданий) | количество вопросов из каждого листа, количество генерируемых вариантов, id таблицы (КИМа) | -
/get_course/<spreadsheet_id> | данные для раздачи заданий в конкретном курсе | id таблицы | {"spreadsheetName": имя таблицы, "folderId": id папки, где лежат сгенерированные формы (задания), "courses": [{"courseId": id курса, "courseName": имя курса, "courseUrl": ссылка на курс}]}
/give_out_variants/<course>&<task_name>&<folder_id>&<start_date>&<start_time>&<end_date>&<end_time> | раздача заданий в курсе | имя курса, название задания, id папки, дата начала, время начала, дата окончания, время окончания | -
/delete_variants/<spreadsheet_id> | удалить формы (варианты заданий) в папке | id таблицы (КИМа) | -

